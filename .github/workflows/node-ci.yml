name: Node.js CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
    build-and-test:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v3

        - name: Set up Node.js
          uses: actions/setup-node@v3
          with:
            node-version: '18'
            cache: 'npm'

        - name: Install dependencies
          run: npm ci

        - name: Run tests
          run: npm test


    
          
 # deploy:
 #   needs: build-and-test
 #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
 #   runs-on: ubuntu-latest
 #   steps:
 #     - name: Checkout code
 #       uses: actions/checkout@v3
 #       
 #     - name: Set up Docker Buildx
 #       uses: docker/setup-buildx-action@v2
 #       
 #     - name: Login to Docker Hub
 #       uses: docker/login-action@v2
 #       with:
 #         username: ${{ secrets.DOCKER_USERNAME }}
 #         password: ${{ secrets.DOCKER_TOKEN }}
 #         
 #     - name: Build and push Docker image
 #       uses: docker/build-push-action@v4
 #       with:
 #         context: .
 #         push: true
 #         tags: ${{ secrets.DOCKER_USERNAME }}/node-app:latest
 #         
 #     - name: Deploy to EC2
 #       uses: appleboy/ssh-action@master
 #       with:
 #         host: ${{ secrets.EC2_HOST }}
 #         username: ubuntu
 #         key: ${{ secrets.EC2_SSH_KEY }}
 #         script: |
 #           cd ~/NodeJs
 #           docker pull ${{ secrets.DOCKER_USERNAME }}/node-app:latest
 #           docker stop node-app || true
 #           docker rm node-app || true
 #           docker run -d -p 3000:3000 --name node-app ${{ secrets.DOCKER_USERNAME }}/node-app:latest